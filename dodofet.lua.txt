local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")


local Config = {
    Enabled = false,
    Mode = "hold",
    Keybind = Enum.KeyCode.E,

    StartDelay = 0.01,
    EndDelay = 0.02,

    Prediction = 0.12,

    TeamCheck = true
}

Config.StartDelay = math.clamp(Config.StartDelay, 0.01, 1)
Config.EndDelay   = math.clamp(Config.EndDelay, Config.StartDelay, 2)

local isToggled = false
local nextShotTime = 0
local mouseHeld = false



local function CheckTeam(player)
    if not Config.TeamCheck then
        return true
    end

    return player.Team ~= LocalPlayer.Team
end


local function CheckInvisible(character)
    for _, part in pairs(character:GetDescendants()) do
        if part:IsA("BasePart") or part:IsA("MeshPart") then
            if part.Transparency < 1 then
                return false 
            end
        end
    end
    return true 
end



local function mouseDown(x, y)
    VirtualInputManager:SendMouseButtonEvent(x, y, 0, true, game, false)
end

local function mouseUp(x, y)
    VirtualInputManager:SendMouseButtonEvent(x, y, 0, false, game, false)
end

local function getMousePosition()
    local pos = UserInputService:GetMouseLocation()
    return pos.X, pos.Y
end



local function isUsingKnife()
    local tool = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Tool")
    if not tool then return false end

    local blacklist = {
        "we all end up fucked guys fuck 3rd person games pain in the ass lol"
    }

    return table.find(blacklist, tool.Name:lower()) ~= nil
end

local function hasForceField(character)
    return character and character:FindFirstChildOfClass("ForceField") ~= nil
end

local function isTyping()
    return UserInputService:GetFocusedTextBox() ~= nil
end



local function isValidCharacterPart(part)
    if not part then return false end

    local character = part:FindFirstAncestorOfClass("Model")
    if not character then return false end

    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid or humanoid.Health <= 0 then return false end

    local player = Players:GetPlayerFromCharacter(character)
    if not player or player == LocalPlayer then
        return false
    end

   
    if not CheckTeam(player) then
        return false
    end

   
    if CheckInvisible(character) then
        return false
    end

    if hasForceField(character) then
        return false
    end

    return true
end



local function getPredictedPosition(part)
    return part.Position + (part.Velocity * Config.Prediction)
end



local function TriggerAction()
    if isTyping() then return false end

    local char = LocalPlayer.Character
    if not char then return false end

    local tool = char:FindFirstChildOfClass("Tool")
    if not tool or isUsingKnife() then
        return false
    end

    local mouse = LocalPlayer:GetMouse()
    local targetPart = mouse.Target
    if not isValidCharacterPart(targetPart) then
        return false
    end

    local predictedPos = getPredictedPosition(targetPart)
    local _, onScreen = Camera:WorldToViewportPoint(predictedPos)
    if not onScreen then
        return false
    end

    local currentTime = os.clock()
    if currentTime < nextShotTime then
        return true
    end

    local x, y = getMousePosition()

    if not mouseHeld then
        mouseDown(x, y)
        mouseHeld = true
    end

    local delay = math.random() * (Config.EndDelay - Config.StartDelay) + Config.StartDelay
    nextShotTime = currentTime + delay

    return true
end



UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if Config.Mode == "toggle" and input.KeyCode == Config.Keybind then
        isToggled = not isToggled
    end
end)

RunService.RenderStepped:Connect(function()
    if not Config.Enabled then return end

    if Config.Mode == "hold" then
        isToggled = UserInputService:IsKeyDown(Config.Keybind)
    end

    local validTarget = false

    if isToggled then
        validTarget = TriggerAction()
    end

    if mouseHeld and (not isToggled or not validTarget) then
        local x, y = getMousePosition()
        mouseUp(x, y)
        mouseHeld = false
    end
end)



local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

local Mouse = Players.LocalPlayer:GetMouse()
local Active = false
local RightClickHeld = false
local FOV = 35
local HitPart = "Closest" -- Options: "Head", "Torso", "HumanoidRootPart", "Left Arm", "Right Arm", "Left Leg", "Right Leg", "Closest"
local TeamCheck = false -- Set to false to target teammates

function CheckTeam(Player)
	if not TeamCheck then
		return true
	end
	if Player.Team == Players.LocalPlayer.Team then
		return false
	end
	return true
end

function CheckInvisible(Character)
	for _, Part in pairs(Character:GetDescendants()) do
		if Part:IsA("BasePart") or Part:IsA("MeshPart") then
			if Part.Transparency < 1 then
				return false
			end
		end
	end
	return true
end

function CheckForcefield(Character)
	if Character:FindFirstChildOfClass("ForceField") then
		return true
	end
	return false
end

function CheckBehind(Character)
	local ignore = {
		Character:WaitForChild("Left Arm"),
		Character:WaitForChild("Right Arm"),
		Character:WaitForChild("Right Leg"),
		Character:WaitForChild("Left Leg"),
		Character:WaitForChild("Torso"),
		Character:WaitForChild("HumanoidRootPart"),
		Players.LocalPlayer.Character:WaitForChild("Left Arm"),
		Players.LocalPlayer.Character:WaitForChild("Right Arm"),
		Players.LocalPlayer.Character:WaitForChild("Right Leg"),
		Players.LocalPlayer.Character:WaitForChild("Left Leg"),
		Players.LocalPlayer.Character:WaitForChild("Torso"),
		Players.LocalPlayer.Character:WaitForChild("HumanoidRootPart")
	}
	local RayCast = Ray.new(Players.LocalPlayer.Character.Head.CFrame.p, (Character.Head.CFrame.p - Players.LocalPlayer.Character.Head.CFrame.p).unit*1000)
	local Part, Pos = workspace:FindPartOnRayWithIgnoreList(RayCast, ignore, false, true)
	local Debris = math.floor((Players.LocalPlayer.Character.Head.CFrame.p - Pos).magnitude*100)/100
	local EndPos = math.floor((Players.LocalPlayer.Character.Head.CFrame.p - Character.Head.CFrame.p).magnitude*100)/100
	if EndPos - Debris < 2 then
		return true
	end
end

function GetClosestBodyPart(Character)
	local BodyParts = {"Head", "Torso", "HumanoidRootPart", "Left Arm", "Right Arm", "Left Leg", "Right Leg"}
	local ClosestPart = nil
	local ClosestDistance = math.huge
	
	for _, PartName in pairs(BodyParts) do
		local Part = Character:FindFirstChild(PartName)
		if Part then
			local Vector, onScreen = workspace.CurrentCamera:WorldToScreenPoint(Part.Position)
			local Magnitude = (Vector2.new(Mouse.X, Mouse.Y)-Vector2.new(Vector.X, Vector.Y)).magnitude
			if Magnitude < ClosestDistance then
				ClosestDistance = Magnitude
				ClosestPart = Part
			end
		end
	end
	
	return ClosestPart
end

function GetTargetPart(Character)
	if HitPart == "Closest" then
		return GetClosestBodyPart(Character)
	else
		return Character:FindFirstChild(HitPart)
	end
end

function FindNearestPlayerToMouse()
	local Nearest
	local Numb = math.huge
	for _, Player in next, Players:GetChildren() do
		if Player and Player ~= Players.LocalPlayer then
			if CheckTeam(Player) == true then
				if Player.Character and CheckInvisible(Player.Character) == false and CheckForcefield(Player.Character) == false then
					if CheckBehind(Player.Character) == true then
						if Player.Character:FindFirstChild("Head") and Player.Character:FindFirstChildOfClass("Humanoid") then 
							local Humanoid = Player.Character:FindFirstChildOfClass("Humanoid")
							if Humanoid.Health > 0 then
								local TargetPart = GetTargetPart(Player.Character)
								if TargetPart then
									local WorldPoint = TargetPart.Position
									local Vector, onScreen = workspace.CurrentCamera:WorldToScreenPoint(WorldPoint)
									local Magnitude = (Vector2.new(Mouse.X, Mouse.Y)-Vector2.new(Vector.X, Vector.Y)).magnitude
									if Numb > Magnitude then 
										if onScreen then
											if Magnitude < FOV then
												Numb = Magnitude
												Nearest = Player
											end
										end
									end
								end
							end
						end
					end
				end
			end
		end
	end
	return Nearest
end

-- MouseButton1 pressed
game:GetService("UserInputService").InputBegan:connect(function(I, G)
	if G then return end
	if I.UserInputType == Enum.UserInputType.MouseButton1 then
		Active = true
	end
	if I.UserInputType == Enum.UserInputType.MouseButton2 then
		RightClickHeld = true
	end
end)

-- MouseButton1 released
game:GetService("UserInputService").InputEnded:connect(function(I, G)
	if G then return end
	if I.UserInputType == Enum.UserInputType.MouseButton1 then
		Active = false
	end
	if I.UserInputType == Enum.UserInputType.MouseButton2 then
		RightClickHeld = false
	end
end)

game:GetService("RunService").Stepped:connect(function()
   if Active and not RightClickHeld then
       if FindNearestPlayerToMouse() then
           local TargetPart = GetTargetPart(FindNearestPlayerToMouse().Character)
           if TargetPart then
               local Vector, onScreen = workspace.CurrentCamera:WorldToScreenPoint(TargetPart.Position)
               local MagnitudeX = Mouse.X - Vector.X
               local MagnitudeY = Mouse.Y - Vector.Y
               mousemoverel((-MagnitudeX * 0.095), (-MagnitudeY * 0.095))
           end
       end
	end
end)




